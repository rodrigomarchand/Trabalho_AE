{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Acervo de Livros</h4>
    <a class="btn btn-primary" href="/livros/cadastrar">+ Cadastrar</a>
</div>

<div id="msg"></div>

<div class="table-responsive">
    <table class="table table-striped align-middle" id="tblLivros">
        <thead>
            <tr>
                <th>ID</th>
                <th>Título</th>
                <th>Autor</th>
                <th>Ano</th>
                <th>Disponível</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    async function carregarLivros() {
        const resp = await fetch("/livros");
        const livros = await resp.json();
        const tbody = document.querySelector("#tblLivros tbody");
        tbody.innerHTML = "";
        livros.forEach(l => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
      <td>${l.id_livro}</td>
      <td>${l.titulo}</td>
      <td>${l.autor}</td>
      <td>${l.ano ?? ""}</td>
      <td>${l.disponivel === 1 ? "Sim" : "Não"}</td>
      <td>
        <button class="btn btn-sm btn-success" ${l.disponivel === 0 ? "disabled" : ""} onclick="emprestar(${l.id_livro})">Emprestar</button>
      </td>
    `;
            tbody.appendChild(tr);
        });
    }

    async function emprestar(id_livro) {
        // Para MVP: empresta com o usuário logado (session no back)
        // Precisamos do id do usuário logado -> criar um endpoint para retornar sessão
        const u = await (await fetch("/usuarios_sessao")).json();
        if (!u || !u.id_usuario) {
            document.getElementById("msg").innerHTML = `<div class="alert alert-warning">Faça login novamente.</div>`;
            return;
        }

        const resp = await fetch("/emprestimos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id_usuario: u.id_usuario, id_livro })
        });
        const data = await resp.json();
        document.getElementById("msg").innerHTML = `<div class="alert alert-${resp.ok ? "success" : "danger"}">${data.msg || "Erro"}</div>`;
        carregarLivros();
    }

    carregarLivros();
</script>
{% endblock %}