{% extends "base.html" %}
{% block content %}
<h4 class="mb-3">üìö {% if session.get('user_tipo') == 'professor' %}Todos os Empr√©stimos{% else %}Meus Empr√©stimos{%
    endif %}</h4>

<div id="msg"></div>

<div class="table-responsive">
    <table class="table table-striped align-middle" id="tblEmprestimos">
        <thead>
            <tr>
                <th>ID</th>
                {% if session.get('user_tipo') == 'professor' %}
                <th>Aluno</th>
                {% endif %}
                <th>Livro</th>
                <th>Data Retirada</th>
                <th>Status</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Modal para confirma√ß√£o de devolu√ß√£o -->
<div class="modal fade" id="modalDevolucao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Devolu√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja registrar a devolu√ß√£o deste livro?</p>
                <p><strong>Livro:</strong> <span id="modalLivroNome"></span></p>
                <p><strong>Aluno:</strong> <span id="modalAlunoNome"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmarDevolucao">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Vari√°vel global para armazenar o empr√©stimo a ser devolvido
    let emprestimoParaDevolver = null;

    // Carrega os empr√©stimos
    async function carregarEmprestimos() {
        try {
            const u = await (await fetch("/usuarios_sessao")).json();
            if (!u || !u.id_usuario) {
                document.getElementById("msg").innerHTML = `<div class="alert alert-warning">Fa√ßa login novamente.</div>`;
                return;
            }

            console.log("Usu√°rio logado:", u);

            // Para professores, carregar todos os empr√©stimos
            // Para alunos, carregar apenas seus pr√≥prios empr√©stimos
            const url = u.tipo === 'professor' ? "/emprestimos" : "/meus_emprestimos_api";
            console.log("Carregando empr√©stimos de:", url);

            const resp = await fetch(url);

            if (!resp.ok) {
                throw new Error('Erro ao carregar empr√©stimos: ' + resp.status);
            }

            const todos = await resp.json();
            console.log("Dados recebidos:", todos);

            const tbody = document.querySelector("#tblEmprestimos tbody");
            tbody.innerHTML = "";

            // Converter ID do usu√°rio da sess√£o para n√∫mero (para compara√ß√£o correta)
            const usuarioId = parseInt(u.id_usuario);

            // Para alunos, usar diretamente os dados da API espec√≠fica
            // Para professores, mostrar todos os empr√©stimos
            const emprestimosExibir = u.tipo === 'professor' ? todos : todos;

            if (emprestimosExibir.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${u.tipo === 'professor' ? 6 : 5}" class="text-center py-4">
                            Nenhum empr√©stimo encontrado
                        </td>
                    </tr>
                `;
                return;
            }

            emprestimosExibir.forEach(e => {
                const tr = document.createElement("tr");

                // Verificar se o usu√°rio atual tem permiss√£o para devolver
                // Para alunos, a API j√° retorna apenas seus empr√©stimos, ent√£o sempre pode devolver
                // Para professores, pode devolver qualquer empr√©stimo
                const usuarioPodeDevolver = u.tipo === 'professor' || parseInt(e.id_usuario) === usuarioId;
                const estaDevolvido = e.status === 'devolvido';

                tr.innerHTML = `
                    <td>${e.id_emprestimo}</td>
                    ${u.tipo === 'professor' ? `<td>${e.usuario}</td>` : ''}
                    <td>${e.livro}</td>
                    <td>${new Date(e.data_retirada).toLocaleDateString('pt-BR')}</td>
                    <td>
                        <span class="badge ${estaDevolvido ? 'bg-success' : 'bg-warning'}">
                            ${estaDevolvido ? 'Devolvido' : 'Ativo'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning" 
                            ${estaDevolvido || !usuarioPodeDevolver ? 'disabled' : ''} 
                            onclick="prepararDevolucao(${e.id_emprestimo}, '${e.livro.replace(/'/g, "\\'")}', '${e.usuario.replace(/'/g, "\\'")}')">
                            Devolver
                        </button>
                        ${!usuarioPodeDevolver ? '<small class="text-muted d-block">N√£o autorizado</small>' : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });

        } catch (error) {
            console.error("Erro:", error);
            document.getElementById("msg").innerHTML = `
                <div class="alert alert-danger">Erro ao carregar empr√©stimos: ${error.message}</div>
            `;
        }
    }

    // Preparar devolu√ß√£o (abrir modal de confirma√ß√£o)
    function prepararDevolucao(idEmprestimo, livroNome, alunoNome) {
        emprestimoParaDevolver = idEmprestimo;
        document.getElementById('modalLivroNome').textContent = livroNome;
        document.getElementById('modalAlunoNome').textContent = alunoNome;

        const modal = new bootstrap.Modal(document.getElementById('modalDevolucao'));
        modal.show();
    }

    // Confirmar devolu√ß√£o
    document.getElementById('btnConfirmarDevolucao').addEventListener('click', async function () {
        if (!emprestimoParaDevolver) return;

        try {
            // Mostrar loading
            const btn = this;
            const originalText = btn.textContent;
            btn.textContent = 'Processando...';
            btn.disabled = true;

            const resp = await fetch(`/devolver/${emprestimoParaDevolver}`, {
                method: "PUT"
            });

            const data = await resp.json();

            if (resp.ok) {
                document.getElementById("msg").innerHTML = `
                    <div class="alert alert-success">${data.msg}</div>
                `;

                // Fechar modal e recarregar dados
                bootstrap.Modal.getInstance(document.getElementById('modalDevolucao')).hide();
                await carregarEmprestimos();

            } else {
                document.getElementById("msg").innerHTML = `
                    <div class="alert alert-danger">${data.msg}</div>
                `;
            }

        } catch (error) {
            console.error("Erro ao devolver:", error);
            document.getElementById("msg").innerHTML = `
                <div class="alert alert-danger">Erro ao registrar devolu√ß√£o.</div>
            `;
        } finally {
            // Restaurar bot√£o
            const btn = document.getElementById('btnConfirmarDevolucao');
            btn.textContent = 'Confirmar';
            btn.disabled = false;
        }
    });

    // Carregar empr√©stimos quando a p√°gina for carregada
    document.addEventListener('DOMContentLoaded', carregarEmprestimos);
</script>

<style>
    .badge {
        font-size: 0.85em;
        padding: 0.35em 0.65em;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }
</style>
{% endblock %}