{% extends "base.html" %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h4 class="mb-3">üìä Dashboard</h4>
        <p class="text-muted">Bem-vindo(a), {{ session['user_nome'] }}! Aqui est√° o resumo do sistema.</p>
    </div>
</div>

<!-- Cards de Estat√≠sticas -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-primary text-white text-center shadow">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-people-fill"></i> Alunos</h5>
                <h3 id="total-alunos" class="card-text">0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-success text-white text-center shadow">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-book-fill"></i> Livros</h5>
                <h3 id="total-livros" class="card-text">0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-info text-white text-center shadow">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-arrow-left-right"></i> Empr√©stimos</h5>
                <h3 id="total-emprestimos" class="card-text">0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-warning text-dark text-center shadow">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-star-fill"></i> Pontos</h5>
                <h3 id="total-pontos" class="card-text">0</h3>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- √öltimos Empr√©stimos -->
    <div class="col-md-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-light">
                <h5 class="mb-0">üìã √öltimos Empr√©stimos</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tblUltimosEmprestimos">
                        <thead class="table-light">
                            <tr>
                                <th>Aluno</th>
                                <th>Livro</th>
                                <th>Data</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Top 3 do Ranking -->
    <div class="col-md-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-light">
                <h5 class="mb-0">üèÜ Top 3 do Ranking</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="topRanking">
                    <div class="list-group-item text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Meu Status (apenas para alunos) -->
{% if session.get('user_tipo') == 'aluno' %}
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-light">
                <h5 class="mb-0">üë§ Meu Status</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Pontua√ß√£o e N√≠vel</h6>
                        <div id="meu-status" class="alert alert-info">
                            Carregando suas informa√ß√µes...
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Meus Empr√©stimos Ativos</h6>
                        <ul class="list-group" id="meus-emprestimos-ativos">
                            <li class="list-group-item">Carregando...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- A√ß√µes R√°pidas (para professores) -->
{% if session.get('user_tipo') == 'professor' %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-light">
                <h5 class="mb-0">‚ö° A√ß√µes R√°pidas</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2 d-md-flex">
                    <a class="btn btn-primary me-md-2" href="/livros/cadastrar">
                        <i class="bi bi-plus-circle"></i> Cadastrar Livro
                    </a>
                    <a class="btn btn-success me-md-2" href="/usuarios/cadastrar">
                        <i class="bi bi-person-plus"></i> Cadastrar Usu√°rio
                    </a>
                    <a class="btn btn-info" href="/livros/listar">
                        <i class="bi bi-list-ul"></i> Ver Todos os Livros
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
    .card {
        border: none;
        border-radius: 10px;
    }

    .card-body h3 {
        font-weight: bold;
    }

    .stats-card {
        transition: transform 0.2s;
    }

    .stats-card:hover {
        transform: translateY(-5px);
    }
</style>

<script>
    // Carregar estat√≠sticas
    async function carregarEstatisticas() {
        try {
            const response = await fetch('/estatisticas');
            const data = await response.json();

            document.getElementById('total-alunos').textContent = data.total_alunos;
            document.getElementById('total-livros').textContent = data.total_livros;
            document.getElementById('total-emprestimos').textContent = data.total_emprestimos;
            document.getElementById('total-pontos').textContent = data.total_pontos;
        } catch (error) {
            console.error('Erro ao carregar estat√≠sticas:', error);
        }
    }

    // Carregar √∫ltimos empr√©stimos
    async function carregarUltimosEmprestimos() {
        try {
            const response = await fetch('/emprestimos');
            const emprestimos = await response.json();

            // Ordenar por data (mais recentes primeiro) e pegar os 5 √∫ltimos
            const ultimos = emprestimos
                .sort((a, b) => new Date(b.data_retirada) - new Date(a.data_retirada))
                .slice(0, 5);

            const tbody = document.querySelector('#tblUltimosEmprestimos tbody');
            tbody.innerHTML = '';

            ultimos.forEach(emp => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${emp.usuario}</td>
                    <td>${emp.livro}</td>
                    <td>${new Date(emp.data_retirada).toLocaleDateString('pt-BR')}</td>
                    <td><span class="badge ${emp.status === 'ativo' ? 'bg-warning' : 'bg-success'}">${emp.status}</span></td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Erro ao carregar √∫ltimos empr√©stimos:', error);
        }
    }

    // Carregar top 3 do ranking
    async function carregarTopRanking() {
        try {
            const response = await fetch('/ranking');
            const ranking = await response.json();
            const top3 = ranking.slice(0, 3);

            const container = document.getElementById('topRanking');
            container.innerHTML = '';

            const medalhas = ['ü•á', 'ü•à', 'ü•â'];

            top3.forEach((aluno, index) => {
                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fs-4">${medalhas[index]}</span>
                            <strong>${aluno.nome}</strong>
                        </div>
                        <div>
                            <span class="badge bg-primary rounded-pill">${aluno.pontos} pts</span>
                            <small class="text-muted">N√≠vel ${aluno.nivel}</small>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        } catch (error) {
            console.error('Erro ao carregar top ranking:', error);
        }
    }

    // Carregar informa√ß√µes do usu√°rio logado (apenas para alunos)
    async function carregarMeuStatus() {
        if ("{{ session.get('user_tipo') }}" !== 'aluno') return;

        try {
            // Carregar posi√ß√£o no ranking
            const response = await fetch('/meu_ranking');
            if (response.ok) {
                const data = await response.json();
                document.getElementById('meu-status').innerHTML = `
                    <strong>Posi√ß√£o:</strong> ${data.posicao}¬∫<br>
                    <strong>Pontua√ß√£o:</strong> ${data.pontos} pontos<br>
                    <strong>N√≠vel:</strong> ${data.nivel}
                `;
            }

            // Carregar empr√©stimos ativos do usu√°rio
            const userResponse = await fetch('/usuarios_sessao');
            const usuario = await userResponse.json();

            const empResponse = await fetch('/emprestimos');
            const todosEmprestimos = await empResponse.json();

            const meusEmprestimosAtivos = todosEmprestimos
                .filter(emp => emp.usuario === usuario.nome && emp.status === 'ativo')
                .slice(0, 3); // Limitar a 3 empr√©stimos

            const lista = document.getElementById('meus-emprestimos-ativos');
            lista.innerHTML = '';

            if (meusEmprestimosAtivos.length === 0) {
                lista.innerHTML = '<li class="list-group-item">Nenhum empr√©stimo ativo</li>';
            } else {
                meusEmprestimosAtivos.forEach(emp => {
                    const item = document.createElement('li');
                    item.className = 'list-group-item';
                    item.textContent = `${emp.livro} (desde ${new Date(emp.data_retirada).toLocaleDateString('pt-BR')})`;
                    lista.appendChild(item);
                });
            }
        } catch (error) {
            console.error('Erro ao carregar status do usu√°rio:', error);
        }
    }

    // Carregar todos os dados quando a p√°gina for carregada
    document.addEventListener('DOMContentLoaded', function () {
        carregarEstatisticas();
        carregarUltimosEmprestimos();
        carregarTopRanking();
        carregarMeuStatus();

        // Atualizar a cada 30 segundos
        setInterval(() => {
            carregarEstatisticas();
            carregarUltimosEmprestimos();
            carregarTopRanking();
        }, 30000);
    });
</script>

<!-- Adicionar √≠cones do Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

{% endblock %}